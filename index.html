<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cuenta atr√°s: ¬°vuelta al sushi!</title>
  <meta name="description" content="Cuenta atr√°s personalizable para el gran d√≠a de volver a comer sushi." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üç£</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a; /* slate-900 */
      --panel:#111827ee; /* gray-900 */
      --text:#e5e7eb; /* gray-200 */
      --muted:#9ca3af; /* gray-400 */
      --accent:#f97316; /* orange-500 */
      --accent-2:#22c55e; /* green-500 */
      --ring:#334155; /* slate-700 */
      --card:#0b1222;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--text); background:radial-gradient(1200px 800px at 80% -20%, #1f2937 0, transparent 50%),
                         radial-gradient(1000px 600px at -20% 20%, #0b1222 0, transparent 60%),
                         var(--bg);
    }
    .wrap{max-width:920px;margin:0 auto;padding:24px}
    header{display:flex;gap:14px;align-items:center;justify-content:space-between;margin:10px 0 24px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{font-size:30px}
    .title{font-weight:800; font-size:22px; letter-spacing:0.2px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
          border:1px solid #1f2937; box-shadow:0 10px 30px rgba(0,0,0,.35);
          border-radius:18px; padding:18px}
    .grid{display:grid; grid-template-columns:1.1fr .9fr; gap:18px}
    @media (max-width:860px){.grid{grid-template-columns:1fr}}

    /* Countdown big */
    .clock{display:flex;flex-wrap:wrap;gap:10px;align-items:stretch;justify-content:center;margin-top:6px}
    .pill{min-width:120px;flex:1 1 160px; background:var(--card); border:1px solid #1e293b; border-radius:16px; padding:16px; text-align:center}
    .num{font-size:42px;font-weight:800;line-height:1}
    .lbl{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:6px}

    /* Right column */
    .controls{display:grid;gap:12px}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="date"], input[type="text"]{
      width:100%; padding:12px 14px; border-radius:12px; background:#0b1222; color:var(--text);
      border:1px solid #1f2937; outline:none; transition:border-color .2s, box-shadow .2s
    }
    input:focus{border-color:#334155; box-shadow:0 0 0 4px rgba(51,65,85,.35)}

    .btns{display:flex;flex-wrap:wrap;gap:10px}
    button, .ghost{
      appearance:none; border:none; cursor:pointer; padding:12px 16px; border-radius:12px; font-weight:600;
    }
    .primary{background:linear-gradient(180deg, #fb923c, #f97316); color:#0b1222}
    .secondary{background:#111827; color:#e5e7eb; border:1px solid #374151}
    .ghost{background:transparent; color:var(--muted)}

    /* Progress ring */
    .ring-wrap{position:relative; display:grid; place-items:center; margin:8px auto; width:280px; height:280px}
    svg{overflow:visible}
    .ring-bg{stroke:var(--ring);opacity:.6}
    .ring{stroke:var(--accent); filter:drop-shadow(0 0 8px rgba(249,115,22,.45))}
    .ring-text{position:absolute;text-align:center}
    .ring-text .big{font-size:44px;font-weight:800}
    .ring-text .small{font-size:12px;color:var(--muted)}

    /* Tips */
    .tips{display:grid; gap:10px; margin-top:6px}
    .tip{background:#0b1222; border:1px dashed #334155; padding:12px 14px; border-radius:12px; font-size:14px}

    /* Footer */
    footer{margin-top:18px;color:var(--muted);font-size:12px;text-align:center}

    /* Confetti (emoji) */
    .confetti{position:fixed; inset:0; pointer-events:none; overflow:hidden}
    .piece{position:absolute; font-size:24px; animation: fall linear forwards}
    @keyframes fall{to{transform:translate3d(var(--x), 110vh, 0) rotate(var(--rot)); opacity:.9}}

    .success{color:#bbf7d0}
    .danger{color:#fecaca}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">üç£</div>
        <div>
          <div class="title">Cuenta atr√°s: ¬°vuelta al sushi!</div>
          <div style="color:var(--muted); font-size:12px">Hazlo personal, comparte el enlace y suelta confeti cuando llegue el d√≠a.</div>
        </div>
      </div>
      <a class="ghost" id="aboutBtn" href="#">¬øC√≥mo funciona?</a>
    </header>

    <div class="grid">
      <!-- LEFT: Countdown + ring -->
      <section class="card">
        <div class="ring-wrap" aria-live="polite" aria-atomic="true">
          <svg width="280" height="280" viewBox="0 0 120 120" role="img" aria-label="Progreso hasta el D√≠a del Sushi">
            <circle class="ring-bg" cx="60" cy="60" r="52" fill="none" stroke-width="8" />
            <circle class="ring" id="ring" cx="60" cy="60" r="52" fill="none" stroke-width="8" stroke-linecap="round" transform="rotate(-90 60 60)" stroke-dasharray="0 999" />
          </svg>
          <div class="ring-text">
            <div class="small">Falta</div>
            <div class="big" id="bigDays">‚Äì</div>
            <div class="small" id="bigLabel">d√≠as</div>
          </div>
        </div>

        <div class="clock" id="clock">
          <div class="pill"><div class="num" id="d">‚Äì</div><div class="lbl">D√≠as</div></div>
          <div class="pill"><div class="num" id="h">‚Äì</div><div class="lbl">Horas</div></div>
          <div class="pill"><div class="num" id="m">‚Äì</div><div class="lbl">Minutos</div></div>
          <div class="pill"><div class="num" id="s">‚Äì</div><div class="lbl">Segundos</div></div>
        </div>
        <div id="status" style="text-align:center; margin-top:10px"></div>
      </section>

      <!-- RIGHT: Controls + tips -->
      <aside class="card">
        <div class="controls">
          <div>
            <label for="name">Nombre de la homenajeada (opcional)</label>
            <input id="name" type="text" placeholder="Ej.: Marta" autocomplete="name" />
          </div>
          <div>
            <label for="date">D√≠a del sushi (elige la fecha objetivo)</label>
            <input id="date" type="date" />
          </div>
          <div class="btns">
            <button class="primary" id="save">Guardar y generar enlace</button>
            <button class="secondary" id="share">Compartir</button>
            <button class="secondary" id="ics">A√±adir al calendario (.ics)</button>
            <button class="ghost" id="reset">Reiniciar</button>
          </div>
        </div>

        <div class="tips">
          <div class="tip" id="tip1">Idea: mete el enlace en un QR y p√©galo en una cajita de palillos. Clase y maldad a partes iguales.</div>
          <div class="tip" id="tip2">Sugerencias de antojos entre tanto: maki de aguacate, tamago (tortilla), uramaki California cocido. Si hay dudas, mejor consultar con su profesional de salud.</div>
          <div class="tip" id="tip3">Truco: puedes pasar la URL con la fecha y el nombre ya metidos para que aparezca todo bonito al abrir.</div>
        </div>
      </aside>
    </div>

    <footer>
      Hecho con ‚ù§Ô∏è y humor. No es consejo m√©dico; elige la fecha que m√°s ilusi√≥n os haga.
    </footer>
  </div>

  <div class="confetti" id="confetti" aria-hidden="true"></div>

  <script>
    // ===== Helper: qs =====
    const $ = (sel) => document.querySelector(sel);

    // ===== State =====
    const state = {
      name: '',
      target: null,     // Date object
      start: null       // Date the countdown was set (for progress ring)
    };

    // ===== Load from URL / localStorage =====
    function loadInitial(){
      const params = new URLSearchParams(location.search);
      const name = params.get('name') || localStorage.getItem('sushi_name') || '';
      const dateStr = params.get('date') || localStorage.getItem('sushi_date') || '';
      const startStr = localStorage.getItem('sushi_start') || '';

      if(name){ $('#name').value = name; state.name = name; }
      if(dateStr){ $('#date').value = dateStr; state.target = parseDate(dateStr); }
      if(startStr){ state.start = new Date(startStr); }

      // If nothing set, nudge a hint date ~6 semanas vista
      if(!state.target){
        const d = new Date(); d.setDate(d.getDate() + 42); // 6 semanas
        $('#date').value = toDateInputValue(d); // default suggestion
      }

      tick();
      updateTitle();
      updateShareAvailability();
    }

    function parseDate(yyyyMMdd){
      // Date input is treated as local time at 00:00
      const [y,m,d] = yyyyMMdd.split('-').map(Number);
      return new Date(y, m-1, d, 0, 0, 0, 0);
    }
    function toDateInputValue(d){
      const z = (n) => String(n).padStart(2,'0');
      return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
    }

    // ===== Countdown logic =====
    let timer = null;
    function startTimer(){
      if(timer) clearInterval(timer);
      timer = setInterval(tick, 1000);
    }

    function tick(){
      const now = new Date();
      const t = state.target; // may be null until set
      if(!t){ fillPlaceholders(); return; }

      const diffMs = t - now;
      const past = diffMs <= 0;

      const absMs = Math.abs(diffMs);
      const s = Math.floor(absMs / 1000) % 60;
      const m = Math.floor(absMs / (1000*60)) % 60;
      const h = Math.floor(absMs / (1000*60*60)) % 24;
      const d = Math.floor(absMs / (1000*60*60*24));

      $('#d').textContent = d;
      $('#h').textContent = h;
      $('#m').textContent = m;
      $('#s').textContent = s;
      $('#bigDays').textContent = d;
      $('#bigLabel').textContent = d === 1 ? 'd√≠a' : 'd√≠as';

      // Status line
      const who = state.name ? `${state.name} ` : '';
      if(past){
        $('#status').innerHTML = `<span class="success">Ya es el D√≠a del Sushi. ${who}‚Äî¬°maki a estribor!</span>`;
        celebrate();
      } else {
        const pretty = t.toLocaleDateString(undefined, {weekday:'long', year:'numeric', month:'long', day:'numeric'});
        $('#status').innerHTML = `Objetivo: <b>${pretty}</b>${state.name ? ` para <b>${state.name}</b>`:''}`;
      }

      // Ring progress: if we have a start date, show % completado del trayecto
      const start = state.start;
      const ring = $('#ring');
      const R = 52; const C = 2 * Math.PI * R;
      let pct = 0.0001; // min dash to keep rounded caps nice
      if(start && t > start){
        const total = t - start;
        const done = now - start;
        pct = Math.min(1, Math.max(0.0001, done / total));
      }
      const dash = C * pct;
      ring.setAttribute('stroke-dasharray', `${dash} ${C}`);
    }

    function fillPlaceholders(){
      ['#d','#h','#m','#s','#bigDays'].forEach(id => $(id).textContent = '‚Äì');
      $('#status').textContent = 'Elige una fecha objetivo y dale a Guardar.';
    }

    // ===== Actions =====
    $('#save').addEventListener('click', () => {
      const name = $('#name').value.trim();
      const dateVal = $('#date').value;
      if(!dateVal){ alert('Elige una fecha v√°lida.'); return; }
      state.name = name; state.target = parseDate(dateVal);
      if(!state.start) state.start = new Date();

      localStorage.setItem('sushi_name', name);
      localStorage.setItem('sushi_date', dateVal);
      localStorage.setItem('sushi_start', state.start.toISOString());

      // Update URL with params for easy sharing
      const url = new URL(location.href);
      url.searchParams.set('date', dateVal);
      if(name) url.searchParams.set('name', name); else url.searchParams.delete('name');
      history.replaceState({}, '', url);

      tick();
      updateTitle();
      flash('Guardado. Enlace listo para compartir.');
    });

    $('#share').addEventListener('click', async () => {
      const url = location.href;
      const title = 'Cuenta atr√°s: ¬°vuelta al sushi!';
      const text = state.name ? `Faltan ${$('#d').textContent} d√≠as para el sushi de ${state.name}.` : `Faltan ${$('#d').textContent} d√≠as para el sushi.`;
      if(navigator.share){
        try{ await navigator.share({title, text, url}); }
        catch(e){ /* user canceled */ }
      } else {
        await navigator.clipboard.writeText(url);
        flash('Enlace copiado al portapapeles.');
      }
    });

    $('#ics').addEventListener('click', () => {
      if(!state.target){ alert('Primero elige y guarda una fecha.'); return; }
      const title = state.name ? `D√≠a del sushi de ${state.name}` : 'D√≠a del sushi';
      const dt = state.target; // local time 00:00
      // Make it an all-day event on that date in local time (no TZ)
      const dtStart = formatICSDate(dt);
      // End date should be next day for all-day events
      const dtEnd = formatICSDate(new Date(dt.getFullYear(), dt.getMonth(), dt.getDate()+1));
      const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//sushi-countdown//ES
BEGIN:VEVENT
DTSTAMP:${formatICSDate(new Date())}Z
UID:${crypto.randomUUID()}
DTSTART;VALUE=DATE:${dtStart}
DTEND;VALUE=DATE:${dtEnd}
SUMMARY:${escapeICS(title)}
DESCRIPTION:${escapeICS('Cuenta atr√°s: ¬°vuelta al sushi!')}
END:VEVENT
END:VCALENDAR`;
      const blob = new Blob([ics], {type:'text/calendar'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'dia-del-sushi.ics';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    $('#reset').addEventListener('click', () => {
      localStorage.removeItem('sushi_name');
      localStorage.removeItem('sushi_date');
      localStorage.removeItem('sushi_start');
      state.name = ''; state.target = null; state.start = null;
      $('#name').value = '';
      $('#date').value = '';
      history.replaceState({}, '', location.pathname);
      tick(); updateTitle();
      flash('Reiniciado.');
    });

    $('#aboutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      alert('1) Pon nombre y fecha.\n2) Guarda para fijar el enlace.\n3) Comparte o a√±ade al calendario.\n4) Cuando llegue el d√≠a: confeti y üç£.');
    });

    function formatICSDate(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}${m}${day}`;
    }
    function escapeICS(s){
      return s.replace(/\/g,'\\').replace(/\n/g,'\\n').replace(/,/g,'\\,').replace(/;/g,'\\;');
    }

    // ===== UI helpers =====
    function flash(msg){
      const el = document.createElement('div');
      el.textContent = msg;
      el.style.position='fixed'; el.style.bottom='20px'; el.style.left='50%'; el.style.transform='translateX(-50%)';
      el.style.background='#111827'; el.style.color='var(--text)'; el.style.padding='10px 14px'; el.style.border='1px solid #374151'; el.style.borderRadius='12px'; el.style.boxShadow='0 8px 24px rgba(0,0,0,.35)';
      document.body.appendChild(el);
      setTimeout(()=>{ el.remove(); }, 2200);
    }

    function updateTitle(){
      const who = state.name ? ` de ${state.name}` : '';
      document.title = state.target ? `Cuenta atr√°s${who} ‚Äî ${$('#d').textContent} d√≠as` : 'Cuenta atr√°s: ¬°vuelta al sushi!';
    }

    function updateShareAvailability(){
      const share = $('#share');
      share.style.opacity = navigator.share ? 1 : 1; // we still enable copy fallback
    }

    // ===== Confetti (emoji-based, tiny and dependency-free) =====
    let celebrated = false;
    function celebrate(){
      if(celebrated) return; celebrated = true;
      const conf = $('#confetti');
      const icons = ['üç£','üçô','ü•¢','üß°','‚ú®'];
      const N = 120;
      for(let i=0;i<N;i++){
        const span = document.createElement('span');
        span.className='piece';
        span.textContent = icons[Math.floor(Math.random()*icons.length)];
        const startX = Math.random()*100; // vw
        const dx = (Math.random()*2-1)*40 + 'vw'; // drift
        const rot = (Math.random()*720-360)+'deg';
        span.style.left = startX+'vw';
        span.style.top = '-5vh';
        span.style.setProperty('--x', dx);
        span.style.setProperty('--rot', rot);
        span.style.animationDuration = (2.2 + Math.random()*1.6)+'s';
        span.style.opacity = 0.7;
        conf.appendChild(span);
        setTimeout(()=>span.remove(), 4000);
      }
    }

    // ===== Kickoff =====
    loadInitial();
    startTimer();
  </script>
</body>
</html>
